# This file contains common pin mappings for the BigTreeTech Octopus
# Pro v1.1 board.

# Important! Do not use this config with an Octopus Pro v1.0 board nor
# non-Pro board.

# To use this config, during "make menuconfig", select "Enable
# low-level configuration options", select the STM32H723
# micro-controller, select a "128KiB bootloader", and select a "25Mhz
# crystal".

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 10
max_z_accel: 100

[stepper_y]
step_pin: DRIVER0_STEP
dir_pin: DRIVER0_DIR
enable_pin: !DRIVER0_EN
microsteps: 32
rotation_distance: 40
endstop_pin: ^PF6
position_endstop: 0
position_max: 305
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: DRIVER0_CS
run_current: 0.600
stealthchop_threshold: 999999

# Driver1
[stepper_x]
step_pin: DRIVER1_STEP
dir_pin: DRIVER1_DIR
enable_pin: !DRIVER1_EN
microsteps: 32
rotation_distance: 40
endstop_pin: ^PF4
position_endstop: 0
position_max: 295
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: DRIVER1_CS
run_current: 0.600
stealthchop_threshold: 999999

# Driver2
[stepper_z]
step_pin: DRIVER2_STEP
dir_pin: !DRIVER2_DIR
enable_pin: !DRIVER2_EN
microsteps: 32
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
position_min: -10
position_max: 330

[tmc2209 stepper_z]
uart_pin: DRIVER2_CS
run_current: 0.600
stealthchop_threshold: 999999

[stepper_z1]
step_pin: DRIVER3_STEP
dir_pin: !DRIVER3_DIR
enable_pin: !DRIVER3_EN
microsteps: 32
rotation_distance: 4

[tmc2209 stepper_z1]
uart_pin: DRIVER3_CS
run_current: 0.600
stealthchop_threshold: 999999

[extruder]
max_extrude_only_distance: 120.0
step_pin: DRIVER7_STEP
dir_pin: !DRIVER7_DIR
enable_pin: !DRIVER7_EN
microsteps: 16
rotation_distance: 7.96
nozzle_diameter: 0.600
max_extrude_cross_section: 3.0
filament_diameter: 1.750
sensor_type: MAX31865
sensor_pin: MAX31865_CS
spi_bus: spi1
heater_pin: PA3
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 460
# Calibrate - see https://www.klipper3d.org/Pressure_Advance.html
pressure_advance: 0.0

[tmc2209 extruder]
uart_pin: DRIVER7_CS
run_current: 0.600
stealthchop_threshold: 999999

[heater_bed]
heater_pin: PA0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF3
#control: pid
#pid_Kp: 54.027
#pid_Ki: 0.770
#pid_Kd: 948.182
min_temp: 0
max_temp: 130

[fan]
pin: !PD14
tachometer_pin: PG10
off_below: 0.10
cycle_time: 0.00004

[heater_fan heatbreak_fan]
pin: !PD15
tachometer_pin: PG11
off_below: 0.2
cycle_time: 0.00004

[controller_fan controller_fan_right]
pin: !PD12
enable_pin: PD13
tachometer_pin: PG9
max_power: 0.5
off_below: 0.2
cycle_time: 0.00004

[controller_fan controller_fan_left]
pin: PE5
tachometer_pin: PG6
max_power: 0.5
off_below: 0.2
cycle_time: 0.00004

[filament_switch_sensor filament]
switch_pin: PG15

[temperature_sensor raspberry_pi]
sensor_type: temperature_host

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu

[mcu]
# Run ls /dev/serial/by-id/* for micro-controller name
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_3F000A000251313433343333-if00
restart_method: command

[board_pins]
aliases:
	# EXP1 header
	EXP1_1=PE8, EXP1_2=PE7,
	EXP1_3=PE9, EXP1_4=PE10,
	EXP1_5=PE12, EXP1_6=PE13,
	EXP1_7=PE14, EXP1_8=PE15,
	EXP1_9=<GND>, EXP1_10=<5V>,

	# EXP2 header
	EXP2_1=PA6, EXP2_2=PA5,
	EXP2_3=PB1, EXP2_4=PA4,
	EXP2_5=PB2, EXP2_6=PA7,
	EXP2_7=PC15, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5,

	# Driver0
	DRIVER0_STEP=PF13, DRIVER0_DIR=PF12,
	DRIVER0_EN=PF14, DRIVER0_CS=PC4,

	# Driver1
	DRIVER1_STEP=PG0, DRIVER1_DIR=PG1,
	DRIVER1_EN=PF15, DRIVER1_CS=PD11,

	# Driver2
	DRIVER2_STEP=PF11, DRIVER2_DIR=PG3,
	DRIVER2_EN=PG5, DRIVER2_CS=PC6,

	# Driver3
	DRIVER3_STEP=PG4, DRIVER3_DIR=PC1,
	DRIVER3_EN=PA2, DRIVER3_CS=PC7,

	# Driver4
	DRIVER4_STEP=PF9, DRIVER4_DIR=PF10,
	DRIVER4_EN=PG2, DRIVER4_CS=PF2,

	# Driver5
	DRIVER5_STEP=PC13, DRIVER5_DIR=PF0,
	DRIVER5_EN=PF1, DRIVER5_CS=PE4,

	# Driver6
	DRIVER6_STEP=PE2, DRIVER6_DIR=PE3,
	DRIVER6_EN=PD4, DRIVER6_CS=PE1,

	# Driver6
	DRIVER6_STEP=PE2, DRIVER6_DIR=PE3,
	DRIVER6_EN=PD4, DRIVER6_CS=PE1,

	# Driver7
	DRIVER7_STEP=PE6, DRIVER7_DIR=PA14,
	DRIVER7_EN=PE0, DRIVER7_CS=PD3,

	# MAX31865
	MAX31865_CS=PF8

[display]
lcd_type: st7920
cs_pin: EXP1_7
sclk_pin: EXP1_6
sid_pin: EXP1_8
encoder_pins: ^EXP1_5, ^EXP1_3
click_pin: ^!EXP1_2
menu_timeout: 30

[output_pin beeper]
pin: EXP1_1

[probe]
pin: !PF5
samples: 3
x_offset: 55
y_offset: 10
speed: 5
samples_result: median
samples_tolerance: 0.0125
samples_tolerance_retries: 10

[z_tilt]
z_positions:
	-25, 160
	335, 160
points:
	0, 160
	240, 160
retries: 10
retry_tolerance: 0.0125

[safe_z_home]
z_hop: 5
home_xy_position: 100, 160

[force_move]
enable_force_move: True

[bed_mesh]
mesh_min: 55, 20
mesh_max: 290, 315
probe_count: 9, 9
algorithm: bicubic

# Uncommented because I use the one from klipper-macros
#[idle_timeout]
#timeout: 300
#gcode:
#	M84
#	TURN_OFF_HEATERS
#	UPDATE_DELAYED_GCODE ID=LOOP_TURN_OFF_PRINTER DURATION=5

[gcode_arcs]
resolution: 1.0

[exclude_object]

[pause_resume]

[include macros.cfg]
[include klipper-macros.cfg]
[include timelapse.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.117500, -0.058750, -0.015000, -0.011875, 0.005000, 0.035625, 0.101875, 0.076875, 0.035000, 0.018125, 0.005000, 0.040000, -0.038750, -0.118125, -0.164375, -0.199375, -0.235625
#*# 	-0.122500, -0.069375, -0.015000, -0.013125, 0.006875, 0.042500, 0.115000, 0.091875, 0.058750, 0.054375, 0.048125, 0.088750, 0.018125, -0.056250, -0.098125, -0.128125, -0.171250
#*# 	-0.087500, -0.038125, 0.007500, 0.010000, 0.030000, 0.065625, 0.125000, 0.103750, 0.070000, 0.061875, 0.049375, 0.086250, 0.010625, -0.066875, -0.101875, -0.142500, -0.180625
#*# 	-0.076875, -0.029375, 0.017500, 0.018750, 0.039375, 0.074375, 0.141875, 0.122500, 0.088750, 0.082500, 0.073750, 0.112500, 0.041875, -0.031250, -0.061875, -0.089375, -0.124375
#*# 	-0.061250, -0.011250, 0.038750, 0.040625, 0.055625, 0.085000, 0.145000, 0.130000, 0.094375, 0.085000, 0.076875, 0.116250, 0.048125, -0.018750, -0.042500, -0.070625, -0.097500
#*# 	-0.069375, -0.019375, 0.031250, 0.033125, 0.047500, 0.078125, 0.142500, 0.117500, 0.081250, 0.073125, 0.070625, 0.108125, 0.045000, -0.028750, -0.054375, -0.081875, -0.100625
#*# 	-0.032500, 0.012500, 0.058750, 0.058125, 0.066875, 0.086875, 0.138125, 0.113750, 0.068750, 0.056250, 0.051875, 0.085625, 0.013750, -0.066250, -0.096250, -0.128125, -0.155000
#*# 	-0.055000, -0.011250, 0.033750, 0.033750, 0.038125, 0.061875, 0.120000, 0.092500, 0.049375, 0.036875, 0.032500, 0.063750, -0.002500, -0.075625, -0.103750, -0.135000, -0.158750
#*# 	-0.078125, -0.034375, 0.011250, 0.011250, 0.014375, 0.038125, 0.092500, 0.070625, 0.026875, 0.013750, 0.012500, 0.043750, -0.018750, -0.086250, -0.115000, -0.142500, -0.163125
#*# 	-0.113125, -0.073750, -0.030625, -0.030000, -0.028125, -0.001250, 0.058125, 0.035000, -0.008125, -0.016875, -0.018750, 0.008750, -0.046875, -0.111875, -0.137500, -0.163125, -0.180000
#*# 	-0.123125, -0.086250, -0.044375, -0.043750, -0.042500, -0.018125, 0.025000, 0.006875, -0.036250, -0.049375, -0.056875, -0.033125, -0.094375, -0.161250, -0.187500, -0.214375, -0.236875
#*# 	-0.175625, -0.131875, -0.088125, -0.080000, -0.082500, -0.050625, -0.001875, -0.019375, -0.062500, -0.076250, -0.081875, -0.058750, -0.113125, -0.179375, -0.203125, -0.228125, -0.250625
#*# 	-0.218125, -0.176250, -0.134375, -0.123125, -0.120625, -0.086875, -0.044375, -0.055625, -0.095000, -0.111250, -0.113750, -0.081875, -0.134375, -0.195000, -0.211250, -0.233750, -0.256875
#*# 	-0.228125, -0.189375, -0.150625, -0.136875, -0.131875, -0.095625, -0.047500, -0.063125, -0.099375, -0.116875, -0.119375, -0.083750, -0.137500, -0.204375, -0.220625, -0.245000, -0.270000
#*# 	-0.268750, -0.223125, -0.183750, -0.169375, -0.163750, -0.126875, -0.081250, -0.088750, -0.123125, -0.143125, -0.145000, -0.110625, -0.159375, -0.222500, -0.243750, -0.260000, -0.285000
#*# 	-0.315000, -0.269375, -0.231875, -0.211875, -0.204375, -0.163125, -0.112500, -0.121875, -0.151875, -0.170000, -0.170625, -0.137500, -0.183750, -0.244375, -0.260625, -0.275625, -0.295625
#*# 	-0.368125, -0.316250, -0.273125, -0.250625, -0.238750, -0.193125, -0.143750, -0.147500, -0.172500, -0.188750, -0.183125, -0.153750, -0.196875, -0.256875, -0.265625, -0.276250, -0.291875
#*# x_count = 17
#*# y_count = 17
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 55.0
#*# max_x = 289.88
#*# min_y = 20.0
#*# max_y = 314.88000000000005
#*#
#*# [probe]
#*# z_offset = 0.980
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 22.395
#*# pid_ki = 0.844
#*# pid_kd = 148.647
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 74.641
#*# pid_ki = 1.026
#*# pid_kd = 1357.528
